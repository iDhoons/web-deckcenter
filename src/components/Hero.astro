---
interface Props {
  title: string;
  description: string;
  ctaText?: string;
  ctaLink?: string;
  image?: string;
  videoUrl?: string;
  youtubeId?: string;
  eyebrow?: string;
  highlights?: string[];
}

const {
  title,
  description,
  ctaText,
  ctaLink,
  image,
  videoUrl,
  youtubeId,
  eyebrow,
  highlights,
} = Astro.props;
---

<section class="hero-text">
  <div class="hero-text-inner">
    {eyebrow && <span class="eyebrow">{eyebrow}</span>}
    <h1>{title}</h1>
    <p>{description}</p>
    {ctaText && ctaLink && (
      <a href={ctaLink} class="cta">{ctaText}</a>
    )}
    {highlights && highlights.length > 0 && (
      <ul class="hero-highlights">
        {highlights.map((item) => (
          <li>{item}</li>
        ))}
      </ul>
    )}
  </div>
</section>

<section class="hero-media-section">
  <div class="hero-media">
    {videoUrl ? (
      <video
        src={videoUrl}
        poster={image}
        autoplay
        muted
        loop
        playsinline
        preload="auto"
      ></video>
    ) : youtubeId ? (
      <iframe
        src={`https://www.youtube.com/embed/${youtubeId}?autoplay=1&mute=1&loop=1&playlist=${youtubeId}&controls=0&showinfo=0&rel=0&modestbranding=1`}
        title={title}
        frameborder="0"
        allow="autoplay; encrypted-media"
        allowfullscreen
      ></iframe>
    ) : image ? (
      <img src={image} alt={title} loading="eager" />
    ) : null}
  </div>
</section>

<script>
  function initHeroAnimation() {
    const heroMedia = document.querySelector('.hero-media');
    if (!heroMedia) return;

    const INITIAL_MARGIN = 50;
    let ticking = false;

    function easeOutCubic(t: number) {
      return 1 - Math.pow(1 - t, 3);
    }

    function updateClipPath() {
      const rect = heroMedia.getBoundingClientRect();
      const windowHeight = window.innerHeight;
      const progress = Math.min(Math.max(1 - (rect.top / windowHeight), 0), 1);
      const easedProgress = easeOutCubic(progress);
      const margin = INITIAL_MARGIN * (1 - easedProgress);
      (heroMedia as HTMLElement).style.clipPath = `polygon(${margin}% 0%, ${100 - margin}% 0%, ${100 - margin}% 100%, ${margin}% 100%)`;
      ticking = false;
    }

    function onScroll() {
      if (!ticking) {
        requestAnimationFrame(updateClipPath);
        ticking = true;
      }
    }

    function enableAnimation() {
      // 이전 리스너 제거 후 새로 등록
      if ((window as any).__heroScrollHandler) {
        window.removeEventListener('scroll', (window as any).__heroScrollHandler);
      }
      (window as any).__heroScrollHandler = onScroll;

      updateClipPath();
      window.addEventListener('scroll', onScroll, { passive: true });
    }

    // 스플래시가 있으면 완료 후 시작, 없으면 즉시 시작
    const splash = document.getElementById('splash');
    if (splash && !splash.classList.contains('removed')) {
      window.addEventListener('splash:complete', enableAnimation, { once: true });
    } else {
      enableAnimation();
    }
  }

  // 초기 로드 및 View Transitions 후 모두 실행
  document.addEventListener('astro:page-load', initHeroAnimation);
</script>

<style>
  .hero-text {
    background: var(--color-bg-alt);
    text-align: center;
    padding: 80px 20px;
  }

  .hero-text-inner {
    max-width: var(--max-width);
    margin: 0 auto;
  }

  .eyebrow {
    display: inline-block;
    font-size: 0.9rem;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--color-accent);
    margin-bottom: 1rem;
    font-weight: 700;
  }

  .hero-text h1 {
    color: var(--color-primary);
    margin-bottom: 1.5rem;
    font-size: 2.75rem;
  }

  .hero-text p {
    font-size: 1.25rem;
    color: var(--color-text-light);
    margin-bottom: 2rem;
    max-width: 640px;
    margin-left: auto;
    margin-right: auto;
  }

  .hero-highlights {
    list-style: none;
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 0.75rem;
    margin-top: 1.5rem;
  }

  .hero-highlights li {
    padding: 0.35rem 0.85rem;
    background: rgba(139, 90, 43, 0.1);
    border: 1px solid rgba(139, 90, 43, 0.2);
    border-radius: 999px;
    font-size: 0.95rem;
    color: var(--color-secondary);
  }

  .cta {
    display: inline-block;
    background: var(--color-accent);
    color: white;
    padding: 0.75rem 2rem;
    border-radius: 4px;
    font-weight: 600;
    font-size: 1rem;
  }

  .cta:hover {
    background: var(--color-accent-light);
  }

  /* Dark mode hero */
  :global([data-theme="dark"]) .hero-highlights li {
    background: rgba(0, 163, 204, 0.15);
    border-color: rgba(0, 163, 204, 0.3);
  }

  .hero-media-section {
    position: relative;
    width: 100%;
  }

  .hero-media {
    position: relative;
    overflow: hidden;
    width: 100%;
    aspect-ratio: 16 / 9;
    clip-path: polygon(30% 0%, 70% 0%, 70% 100%, 30% 100%);
    transition: clip-path 0.5s ease-out;
  }

  .hero-media img,
  .hero-media iframe,
  .hero-media video {
    width: 100%;
    height: 100%;
    border: none;
    object-fit: cover;
  }

  @media (max-width: 768px) {
    .hero-text {
      padding: 60px 16px;
    }

    .hero-text h1 {
      font-size: 2rem;
    }

    .hero-text p {
      font-size: 1.1rem;
    }

    .hero-media {
      aspect-ratio: 4 / 3;
    }
  }
</style>
